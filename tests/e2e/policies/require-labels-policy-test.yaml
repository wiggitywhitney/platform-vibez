apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: require-labels-policy-test
spec:
  description: Validate that the require-labels Kyverno policy is working correctly
  steps:
  
  - name: test-missing-team-label-blocked
    try:
    - description: Deploy without team label should be blocked
      script:
        content: |
          # This should fail due to missing team label
          set +e
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: no-team-label-test
            namespace: $NAMESPACE
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:1.25.3
                  resources:
                    limits:
                      cpu: 100m
                      memory: 128Mi
          EOF
          
          # Check if deployment was rejected
          if kubectl get deployment no-team-label-test -n $NAMESPACE >/dev/null 2>&1; then
            echo "ERROR: Deployment without team label was allowed - policy not working"
            exit 1
          else
            echo "SUCCESS: Deployment without team label was correctly blocked"
            exit 0
          fi
    finally:
    - description: Clean up failed deployment attempt
      script:
        content: |
          kubectl delete deployment no-team-label-test -n $NAMESPACE || true

  - name: test-with-team-label-allowed
    try:
    - description: Deploy with team label should be allowed
      script:
        content: |
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: with-team-label-test
            namespace: $NAMESPACE
            labels:
              team: platform
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:1.25.3
                  resources:
                    limits:
                      cpu: 100m
                      memory: 128Mi
          EOF
          
          # Verify deployment was created
          kubectl get deployment with-team-label-test -n $NAMESPACE
          echo "SUCCESS: Deployment with team label was allowed"
    finally:
    - description: Clean up successful deployment
      script:
        content: |
          kubectl delete deployment with-team-label-test -n $NAMESPACE || true 