apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: disallow-latest-tag-policy-test
spec:
  description: Validate that the disallow-latest-tag Kyverno policy is working correctly
  steps:
  
  - name: test-latest-tag-blocked
    try:
    - description: Deploy with latest tag should be blocked
      script:
        content: |
          # This should fail due to latest tag
          set +e
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: latest-tag-test
            namespace: $NAMESPACE
            labels:
              team: platform
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:latest
                  resources:
                    limits:
                      cpu: 100m
                      memory: 128Mi
          EOF
          
          # Check if deployment was rejected
          if kubectl get deployment latest-tag-test -n $NAMESPACE >/dev/null 2>&1; then
            echo "ERROR: Deployment with latest tag was allowed - policy not working"
            exit 1
          else
            echo "SUCCESS: Deployment with latest tag was correctly blocked"
            exit 0
          fi
    finally:
    - description: Clean up failed deployment attempt
      script:
        content: |
          kubectl delete deployment latest-tag-test -n $NAMESPACE || true

  - name: test-version-tag-allowed
    try:
    - description: Deploy with specific version tag should be allowed
      script:
        content: |
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: version-tag-test
            namespace: $NAMESPACE
            labels:
              team: platform
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:1.25.3
                  resources:
                    limits:
                      cpu: 100m
                      memory: 128Mi
          EOF
          
          # Verify deployment was created
          kubectl get deployment version-tag-test -n $NAMESPACE
          echo "SUCCESS: Deployment with version tag was allowed"
    finally:
    - description: Clean up successful deployment
      script:
        content: |
          kubectl delete deployment version-tag-test -n $NAMESPACE || true 