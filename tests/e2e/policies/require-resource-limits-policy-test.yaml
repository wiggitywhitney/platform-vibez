apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: require-resource-limits-policy-test
spec:
  description: Validate that the require-resource-limits Kyverno policy is working correctly
  steps:
  
  - name: test-no-limits-blocked
    try:
    - description: Deploy without resource limits should be blocked
      script:
        content: |
          # This should fail due to missing resource limits
          set +e
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: no-limits-test
            namespace: $NAMESPACE
            labels:
              team: platform
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:1.25.3
          EOF
          
          # Check if deployment was rejected
          if kubectl get deployment no-limits-test -n $NAMESPACE >/dev/null 2>&1; then
            echo "ERROR: Deployment without resource limits was allowed - policy not working"
            exit 1
          else
            echo "SUCCESS: Deployment without resource limits was correctly blocked"
            exit 0
          fi
    finally:
    - description: Clean up failed deployment attempt
      script:
        content: |
          kubectl delete deployment no-limits-test -n $NAMESPACE || true

  - name: test-partial-limits-blocked
    try:
    - description: Deploy with partial limits should be blocked
      script:
        content: |
          # This should fail due to missing memory limit
          set +e
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: partial-limits-test
            namespace: $NAMESPACE
            labels:
              team: platform
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:1.25.3
                  resources:
                    limits:
                      cpu: 100m
                      # memory missing - should be blocked
          EOF
          
          # Check if deployment was rejected
          if kubectl get deployment partial-limits-test -n $NAMESPACE >/dev/null 2>&1; then
            echo "ERROR: Deployment with partial limits was allowed - policy not working"
            exit 1
          else
            echo "SUCCESS: Deployment with partial limits was correctly blocked"
            exit 0
          fi
    finally:
    - description: Clean up failed deployment attempt
      script:
        content: |
          kubectl delete deployment partial-limits-test -n $NAMESPACE || true

  - name: test-complete-limits-allowed
    try:
    - description: Deploy with complete resource limits should be allowed
      script:
        content: |
          kubectl apply -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: complete-limits-test
            namespace: $NAMESPACE
            labels:
              team: platform
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: test
            template:
              metadata:
                labels:
                  app: test
              spec:
                containers:
                - name: app
                  image: nginx:1.25.3
                  resources:
                    limits:
                      cpu: 100m
                      memory: 128Mi
          EOF
          
          # Verify deployment was created
          kubectl get deployment complete-limits-test -n $NAMESPACE
          echo "SUCCESS: Deployment with complete limits was allowed"
    finally:
    - description: Clean up successful deployment
      script:
        content: |
          kubectl delete deployment complete-limits-test -n $NAMESPACE || true 